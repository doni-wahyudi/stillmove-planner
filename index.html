<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stillmove Planner</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="Your personal productivity companion for habits, goals, and time management">
    <meta name="theme-color" content="#6366f1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Planner">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìã</text></svg>">
    <link rel="apple-touch-icon" href="icons/AppImages/android/android-launchericon-192-192.png">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/theme.css">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <!-- PWA Offline Indicator -->
    <div id="offline-indicator" class="offline-indicator" aria-live="polite">
        You are offline
    </div>

    <!-- PWA Install Prompt -->
    <div id="pwa-install-prompt" class="pwa-install-prompt">
        <h4>üì± Install App</h4>
        <p>Install Daily Planner for quick access and offline use.</p>
        <div class="btn-group">
            <button class="btn-dismiss" id="pwa-dismiss">Not now</button>
            <button class="btn-install" id="pwa-install">Install</button>
        </div>
    </div>

    <!-- Sync Indicator -->
    <div id="sync-indicator" class="sync-indicator">
        <div class="sync-spinner"></div>
        <span>Syncing...</span>
    </div>

    <!-- Skip to main content link for keyboard users -->
    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <div id="app" role="application" aria-label="Daily Planner Application">
        <!-- Navigation -->
        <nav class="main-nav" role="navigation" aria-label="Main navigation">
            <div class="nav-brand">
                <h1>Stillmove Planner</h1>
            </div>
            <button id="mobile-menu-toggle" class="mobile-menu-toggle" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <ul class="nav-menu" id="nav-menu" role="menubar" aria-label="Main menu">
                <li role="none"><a href="#dashboard" data-view="dashboard" role="menuitem"
                        aria-label="Navigate to Dashboard view" data-tooltip="Press D">Dashboard</a></li>
                <li role="none"><a href="#weekly" data-view="weekly" role="menuitem"
                        aria-label="Navigate to Weekly view" data-tooltip="Press W">Weekly</a></li>
                <li role="none"><a href="#monthly" data-view="monthly" role="menuitem"
                        aria-label="Navigate to Monthly view" data-tooltip="Press M">Monthly</a></li>
                <li role="none"><a href="#annual" data-view="annual" role="menuitem"
                        aria-label="Navigate to Annual view" data-tooltip="Press A">Annual</a></li>
                <li role="none"><a href="#habits" data-view="habits" role="menuitem"
                        aria-label="Navigate to Habits view" data-tooltip="Press H">Habits</a></li>
                <li role="none"><a href="#action-plan" data-view="action-plan" role="menuitem"
                        aria-label="Navigate to Action Plan view">Action Plan</a></li>
                <li role="none"><a href="#kanban" data-view="kanban" role="menuitem"
                        aria-label="Navigate to Kanban Board view" data-tooltip="Press K">Kanban</a></li>
                <li role="none"><a href="#canvas" data-view="canvas" role="menuitem"
                        aria-label="Navigate to Canvas view" data-tooltip="Press C">Canvas</a></li>
                <li role="none"><a href="#pomodoro" data-view="pomodoro" role="menuitem"
                        aria-label="Navigate to Pomodoro Timer view" data-tooltip="Press P">Pomodoro</a></li>
            </ul>
            <div class="nav-actions">
                <!-- Mini Pomodoro Timer (visible when timer is running) -->
                <div id="mini-timer" class="mini-timer" style="display: none;" aria-label="Pomodoro timer status">
                    <span id="mini-timer-mode" class="mini-timer-mode">Focus</span>
                    <span id="mini-timer-time" class="mini-timer-time">25:00</span>
                    <button id="mini-timer-toggle" class="mini-timer-btn" aria-label="Pause timer">‚è∏</button>
                </div>
                <button id="theme-toggle-btn" class="nav-icon-btn" aria-label="Toggle dark/light mode"
                    title="Toggle Theme">
                    <span class="theme-icon-light" aria-hidden="true">üåô</span>
                    <span class="theme-icon-dark" aria-hidden="true">‚òÄÔ∏è</span>
                </button>
                <button id="keyboard-help-btn" class="nav-icon-btn" aria-label="Keyboard shortcuts"
                    title="Keyboard Shortcuts (?)">
                    <span aria-hidden="true">‚å®Ô∏è</span>
                </button>
                <button id="search-toggle-btn" class="nav-icon-btn" aria-label="Search" title="Search (/)">
                    <span aria-hidden="true">üîç</span>
                </button>
                <div id="search-container" class="search-container hidden">
                    <input type="text" id="global-search" class="global-search-input"
                        placeholder="Search goals, habits, notes..." aria-label="Search">
                    <div id="search-results" class="search-results"></div>
                </div>
            </div>
            <div class="user-menu">
                <button id="user-menu-btn" class="user-menu-btn" aria-haspopup="true" aria-expanded="false"
                    aria-label="User menu">
                    <span id="user-email" aria-live="polite"></span>
                </button>
                <div id="user-dropdown" class="user-dropdown hidden" role="menu" aria-label="User menu options">
                    <a href="#profile" role="menuitem" aria-label="View profile">Profile</a>
                    <a href="#settings" data-view="settings" role="menuitem" aria-label="Open settings">Settings</a>
                    <button id="sign-out-btn" role="menuitem" aria-label="Sign out of application">Sign Out</button>
                </div>
            </div>
        </nav>

        <!-- Breadcrumb Navigation -->
        <nav id="breadcrumb-nav" class="breadcrumb-nav" aria-label="Breadcrumb">
            <span id="breadcrumb-view" class="breadcrumb-view"></span>
            <span class="breadcrumb-separator">‚Ä∫</span>
            <span id="breadcrumb-context" class="breadcrumb-context"></span>
        </nav>

        <!-- Main Content Area -->
        <main id="main-content" class="main-content" role="main" aria-label="Main content">
            <!-- Views will be loaded here dynamically -->
            <div id="view-container" role="region" aria-live="polite"></div>
        </main>

        <!-- Loading Spinner -->
        <div id="loading-spinner" class="loading-spinner hidden" role="status" aria-live="polite" aria-label="Loading">
            <div class="spinner" aria-hidden="true"></div>
            <span class="sr-only">Loading content, please wait...</span>
        </div>

        <!-- Toast Notifications -->
        <div id="toast-container" class="toast-container" role="region" aria-live="polite" aria-label="Notifications">
        </div>

        <!-- Bottom Navigation (Mobile) -->
        <nav id="bottom-nav" class="bottom-nav" role="navigation" aria-label="Mobile navigation">
            <a href="#dashboard" data-view="dashboard" class="bottom-nav-item" aria-label="Dashboard view">
                <span class="bottom-nav-icon">üè†</span>
                <span class="bottom-nav-label">Home</span>
            </a>
            <a href="#weekly" data-view="weekly" class="bottom-nav-item" aria-label="Weekly view">
                <span class="bottom-nav-icon">üìÖ</span>
                <span class="bottom-nav-label">Weekly</span>
            </a>
            <a href="#monthly" data-view="monthly" class="bottom-nav-item" aria-label="Monthly view">
                <span class="bottom-nav-icon">üìÜ</span>
                <span class="bottom-nav-label">Monthly</span>
            </a>
            <a href="#habits" data-view="habits" class="bottom-nav-item" aria-label="Habits view">
                <span class="bottom-nav-icon">‚ú®</span>
                <span class="bottom-nav-label">Habits</span>
            </a>
            <a href="#annual" data-view="annual" class="bottom-nav-item" aria-label="Annual view">
                <span class="bottom-nav-icon">üéØ</span>
                <span class="bottom-nav-label">Annual</span>
            </a>
            <a href="#settings" data-view="settings" class="bottom-nav-item" aria-label="Settings">
                <span class="bottom-nav-icon">‚öôÔ∏è</span>
                <span class="bottom-nav-label">Settings</span>
            </a>
        </nav>

        <!-- Quick Add Floating Action Button -->
        <div id="fab-container" class="fab-container">
            <div id="fab-menu" class="fab-menu">
                <button class="fab-menu-item" data-action="add-habit" aria-label="Add new habit">
                    <span class="fab-menu-icon">‚ú®</span>
                    <span class="fab-menu-label">New Habit</span>
                </button>
                <button class="fab-menu-item" data-action="add-goal" aria-label="Add new goal">
                    <span class="fab-menu-icon">üéØ</span>
                    <span class="fab-menu-label">New Goal</span>
                </button>
                <button class="fab-menu-item" data-action="add-timeblock" aria-label="Add time block">
                    <span class="fab-menu-icon">üìÖ</span>
                    <span class="fab-menu-label">Time Block</span>
                </button>
            </div>
            <button id="fab-button" class="fab-button" aria-label="Quick add menu" aria-expanded="false"
                data-tooltip="Press N">
                <span aria-hidden="true">+</span>
            </button>
        </div>

        <!-- Floating Pomodoro Mini-Player -->
        <div id="pomodoro-float" class="pomodoro-float" style="display: none;" aria-label="Floating Pomodoro timer">
            <div class="pomodoro-float-header">
                <span class="pomodoro-float-title">üçÖ Pomodoro</span>
                <div class="pomodoro-float-actions">
                    <button id="pomodoro-float-minimize" class="pomodoro-float-btn" aria-label="Minimize">‚àí</button>
                    <button id="pomodoro-float-close" class="pomodoro-float-btn" aria-label="Close">√ó</button>
                </div>
            </div>
            <div class="pomodoro-float-body">
                <div class="pomodoro-float-mode" id="pomodoro-float-mode">Focus</div>
                <div class="pomodoro-float-time" id="pomodoro-float-time">25:00</div>
                <div class="pomodoro-float-session" id="pomodoro-float-session">Session 0/4</div>
                <div class="pomodoro-float-controls">
                    <button id="pomodoro-float-toggle" class="pomodoro-float-control-btn primary"
                        aria-label="Start timer">‚ñ∂</button>
                    <button id="pomodoro-float-reset" class="pomodoro-float-control-btn"
                        aria-label="Reset timer">‚Ü∫</button>
                    <button id="pomodoro-float-skip" class="pomodoro-float-control-btn"
                        aria-label="Skip phase">‚è≠</button>
                </div>
            </div>
            <div class="pomodoro-float-minimized" style="display: none;">
                <span id="pomodoro-float-mini-time">25:00</span>
                <button id="pomodoro-float-expand" class="pomodoro-float-btn" aria-label="Expand">+</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <!-- Shared UI Components -->
    <script src="components/modal.js"></script>
    <script src="components/toast.js"></script>
    <script src="components/progress-bar.js"></script>
    <script src="components/calendar.js"></script>
    <script src="components/spinner.js"></script>

    <!-- Accessibility -->
    <script src="js/accessibility.js"></script>

    <!-- Application Scripts -->
    <script type="module" src="js/config.js"></script>
    <script type="module" src="js/supabase-client.js"></script>
    <script type="module" src="js/error-handler.js"></script>
    <script type="module" src="js/app.js"></script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    // Use relative path for GitHub Pages compatibility
                    const swPath = './sw.js';
                    const registration = await navigator.serviceWorker.register(swPath);
                    console.log('[PWA] Service Worker registered:', registration.scope);

                    // Check for updates
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                // New version available
                                if (window.Toast) {
                                    window.Toast.info('New version available! Refresh to update.');
                                }
                            }
                        });
                    });
                } catch (error) {
                    console.error('[PWA] Service Worker registration failed:', error);
                }
            });
        }

        // Offline/Online indicator
        const offlineIndicator = document.getElementById('offline-indicator');

        function updateOnlineStatus() {
            if (navigator.onLine) {
                offlineIndicator.classList.remove('visible');
            } else {
                offlineIndicator.classList.add('visible');
            }
        }

        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        updateOnlineStatus();

        // PWA Install Prompt
        let deferredPrompt;
        const installPrompt = document.getElementById('pwa-install-prompt');
        const installBtn = document.getElementById('pwa-install');
        const dismissBtn = document.getElementById('pwa-dismiss');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Check if user has dismissed before
            if (!localStorage.getItem('pwa_install_dismissed')) {
                setTimeout(() => {
                    installPrompt.classList.add('visible');
                }, 3000);
            }
        });

        if (installBtn) {
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    console.log('[PWA] Install prompt outcome:', outcome);
                    deferredPrompt = null;
                }
                installPrompt.classList.remove('visible');
            });
        }

        if (dismissBtn) {
            dismissBtn.addEventListener('click', () => {
                installPrompt.classList.remove('visible');
                localStorage.setItem('pwa_install_dismissed', 'true');
            });
        }

        window.addEventListener('appinstalled', () => {
            console.log('[PWA] App installed');
            installPrompt.classList.remove('visible');
            deferredPrompt = null;
        });
    </script>
</body>

</html>